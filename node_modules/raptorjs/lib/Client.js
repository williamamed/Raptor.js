var lodash=require('lodash')
/**
* 
* @author William Amed
*/
module.exports={
	/**
	*
	*
	*/
	getContent:function(body,R,response){
		this.R=R;
		this.res=response;
		this.body=body;
		var content=response.req.viewPlugin.get('before_response_body').join('')+body+response.req.viewPlugin.get('after_response_body').join('');
		if(!response.req.xhr && response.req.method=='GET' && (!response.get('Content-type') || response.get('Content-type').indexOf('text/html')!=-1)){
			
			content=this.__core(content);
			if(R.app.get('env')=='development'){
				content+=this.__debug(content);
			}

			return content;
		}else
			return content;
		
	},
	/**
	*
	*
	*/
	__debug:function(content){
		var debug;
		this.res.render(__dirname+'/views/minifyPanel.ejs',{
			time:process.hrtime(this.res.req.profiler.start)[1]/1e9,
		},function(err,str){
			if(err)debug='';
			debug=str;
		})
		this.R.waitUntil(!debug)
		return debug;
	},
	/**
	*
	*
	*/
	__core:function(body){
		var client;
		
		var i18nDef = JSON.stringify(this.R.i18n.getDefinition());
		var language=this.res.req.language;
		var viewStatic=this.R.getViewPlugin('raptor_client')?this.R.getViewPlugin('raptor_client'):[]

		this.res.render(__dirname+'/views/client.ejs',{
			i18nDef: i18nDef,
			i18n: this.R.i18nClass ,
			language: language,
			csrfName: this.R.options.cookieName?this.R.options.cookieName+'A':'_csrf_red',
			plugin: this.res.req.viewPlugin.get('raptor_client')
		},function(err,str){
			if(err)client='';
			client=str;
		})
		this.R.waitUntil(!client)

		if(body.indexOf('<head>')!=-1){
			return body.replace('<head>','<head>'+client);
		}else{
			return client+body;
		}
			
	}
}